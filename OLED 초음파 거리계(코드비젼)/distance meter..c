#include <mega8.h>
#include <delay.h>

#define add 0x78;
#define TWINT   7



void com_write(unsigned int com); //com_write , com_tx
void data_write(unsigned int data); 
void bit_draw(flash unsigned char *ch); //bit_draw
void draw_font_10x16(int x, int y, int ch); //font_10x16
void draw_font_28x32(int x, int ch); //font_28x32
void oled_init(void);
void oled_clear(void); //oled_clear
void draw_dot(int x); //

unsigned int distance = 0,edge_mode = 0, avg_cnt = 0, sum = 0; //distance, edge_mode, avg_cnt, sum
unsigned int digit_1, digit_10, digit_100, digit_1000; //digit_1,digit_10,digit_100,digit_1000

flash unsigned char gretting_screen [] = {        //gretting_screen, init_screen (distance mesurer) 128x32
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x04, 0x04, 0xFC, 0xFC, 0x04,
    0x04, 0x04, 0x04, 0x0C, 0x18, 0xF0, 0xF0, 0xC0, 0x00, 0x04, 0x04, 0x04, 0xFC, 0xFC, 0x04, 0x00,
    0x00, 0x20, 0x78, 0xCC, 0x84, 0x84, 0x84, 0x84, 0x0C, 0x1C, 0x1C, 0x20, 0x00, 0x18, 0x0C, 0x0C,
    0x04, 0x04, 0xFC, 0xFC, 0xFC, 0x04, 0x04, 0x04, 0x1C, 0x1C, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xE0, 0x3C, 0x3C, 0x3C, 0xF8, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x04, 0xFC, 0x1C, 0x70,
    0xE0, 0xE0, 0x80, 0x00, 0x04, 0xFC, 0xFC, 0xFC, 0x04, 0x00, 0xE0, 0xE0, 0xF8, 0x0C, 0x04, 0x04,
    0x04, 0x04, 0x0C, 0x1C, 0x38, 0x38, 0x00, 0x04, 0x04, 0xFC, 0xFC, 0x84, 0x84, 0x84, 0xE4, 0xE4,
    0x0C, 0x1C, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x20, 0x20, 0x3F, 0x3F, 0x20,
    0x20, 0x20, 0x20, 0x30, 0x18, 0x0F, 0x0F, 0x03, 0x00, 0x20, 0x20, 0x20, 0x3F, 0x2F, 0x20, 0x00,
    0x00, 0x18, 0x30, 0x20, 0x21, 0x21, 0x61, 0x61, 0x23, 0x3F, 0x3F, 0x0C, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x20, 0x2F, 0x3F, 0x3F, 0x20, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x38, 0x38, 0x2F,
    0x23, 0x02, 0x02, 0x02, 0x23, 0x2F, 0x3E, 0x3E, 0x30, 0x20, 0x00, 0x20, 0x20, 0x3F, 0x20, 0x20,
    0x00, 0x00, 0x03, 0x07, 0x0C, 0x3F, 0x3F, 0x3F, 0x00, 0x00, 0x0F, 0x0F, 0x1F, 0x38, 0x20, 0x60,
    0x60, 0x60, 0x20, 0x30, 0x1C, 0x1C, 0x04, 0x20, 0x20, 0x3F, 0x3F, 0x21, 0x21, 0x21, 0x27, 0x27,
    0x20, 0x38, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x04, 0x04, 0xFC, 0x3C, 0xE0, 0xE0, 0x80, 0x00, 0x00,
    0x00, 0x00, 0xE0, 0x3C, 0xFC, 0xFC, 0xFC, 0x04, 0x00, 0x04, 0xFC, 0xFC, 0xFC, 0x84, 0x84, 0x84,
    0x84, 0xCC, 0x1C, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0xF0, 0x1C, 0x7C, 0xF0, 0xF0,
    0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0xF8, 0xCC, 0xCC, 0x84, 0x84, 0x0C, 0x1C, 0x1C, 0x38,
    0x00, 0x04, 0x04, 0x04, 0xFC, 0xFC, 0x04, 0x04, 0x00, 0x00, 0x04, 0x04, 0x04, 0xFC, 0x04, 0x04,
    0x04, 0x04, 0x04, 0xFC, 0x6C, 0x04, 0x04, 0x04, 0x8C, 0xF8, 0xF8, 0xF8, 0x00, 0x00, 0x04, 0xFC,
    0xFC, 0xFC, 0x84, 0x84, 0x84, 0x84, 0xCC, 0x0C, 0x38, 0x00, 0x00, 0x00, 0x04, 0xFC, 0xFC, 0xFC,
    0x04, 0x04, 0x04, 0x8C, 0x8C, 0xF8, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x60, 0x60, 0x3F, 0x60, 0x01, 0x01, 0x0F, 0x7C, 0x3C,
    0x07, 0x07, 0x61, 0x60, 0x3F, 0x3F, 0x3F, 0x60, 0x00, 0x60, 0x3F, 0x3F, 0x3F, 0x61, 0x61, 0x61,
    0x61, 0x27, 0x30, 0x38, 0x08, 0x08, 0x60, 0x60, 0x3C, 0x67, 0x67, 0x22, 0x02, 0x02, 0x63, 0x63,
    0x6F, 0x3C, 0x60, 0x60, 0x60, 0x00, 0x38, 0x30, 0x20, 0x20, 0x61, 0x61, 0x61, 0x37, 0x37, 0x1E,
    0x00, 0x00, 0x00, 0x00, 0x1F, 0x3F, 0x20, 0x20, 0x60, 0x60, 0x60, 0x30, 0x30, 0x1F, 0x00, 0x00,
    0x60, 0x60, 0x60, 0x3F, 0x6D, 0x61, 0x61, 0x03, 0x0F, 0x38, 0x30, 0x30, 0x60, 0x00, 0x60, 0x3F,
    0x3F, 0x3F, 0x61, 0x61, 0x61, 0x61, 0x27, 0x30, 0x38, 0x08, 0x08, 0x00, 0x60, 0x3F, 0x3F, 0x3F,
    0x61, 0x03, 0x0F, 0x1C, 0x1C, 0x30, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};



// 10x16 폰트 배열
flash unsigned char font_10x16 [12][20] = {   //font_10x16
    //0
    {0x00, 0xC0, 0xE0, 0xF0, 0xF0, 0x38, 0x18, 0x88, 0xF8, 0xF0, 0x0F, 0x1F, 0x1F, 0x13, 0x18, 0x0C, 0x06, 0x03, 0x01, 0x00},
    //1
    {0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xF0, 0XF8, 0X38, 0X18, 0x02, 0x12, 0x1B, 0x1D, 0x1F, 0x0F, 0x03, 0x00, 0x00, 0x00},
    //2
    {0x00, 0x00, 0xE0, 0xF0, 0xF0, 0x38, 0x88, 0xF8, 0xF8, 0x70, 0x10, 0x18, 0x0C, 0x1E, 0x1E, 0x1B, 0x19, 0x18, 0x08, 0x00},
    //3
    {0x00, 0x00, 0x00, 0x70, 0x70, 0xB8, 0x88, 0xC8, 0x78 ,0x78, 0x0E, 0x1E, 0x16, 0x10, 0x18, 0x1C, 0x1F, 0x0F, 0x07, 0x00},
    //4
    {0x00, 0x00, 0x00, 0xC0, 0xE0, 0x78, 0x38, 0x98, 0xC8, 0x40, 0x04, 0x06, 0x13, 0x1F, 0x1C, 0x1E, 0x0F, 0x05, 0x04, 0x00},
    //5
    {0x00, 0x00, 0x00, 0xC0, 0xF0, 0xB8, 0x98, 0x98, 0x18, 0x08, 0x0C, 0x1C, 0x14, 0x10, 0x18, 0x1C, 0x1F, 0x0F, 0x07, 0x00},
    //6
    {0x00, 0x00, 0xC0, 0xE0, 0xF0, 0xF0, 0x98, 0x88, 0x38, 0x38, 0x00, 0x0F, 0x1F, 0x1F, 0x13, 0x1D, 0x1F, 0x0F, 0x07, 0x00},
    //7
    {0x00, 0x00, 0x00, 0x20, 0x38, 0x98, 0xD0, 0xF0, 0x30, 0x18, 0x00, 0x00, 0x38, 0x3E, 0x3F, 0x07, 0x01, 0x00, 0x00, 0x00},
    //8
    {0x00, 0x00, 0x00, 0x70, 0xF0, 0xF8, 0xC8, 0xF8, 0x78, 0x30, 0x0E, 0x1F, 0x1F, 0x11, 0x11, 0x11, 0x1F, 0x0F, 0x07, 0x00},
    //9
    {0x00, 0x00, 0xE0, 0xF0, 0xF8, 0x38, 0xC8, 0xF8, 0xF8, 0xF0, 0x0C, 0x1C, 0x1C, 0x11, 0x19, 0x0D, 0x0F, 0x07, 0x03, 0x00},
    //c
    {0x00, 0x00, 0x80, 0xC0, 0x60, 0x20, 0x20, 0x20, 0x20, 0x00, 0x00, 0x00, 0x0F, 0x1F, 0x30, 0x20, 0x20, 0x20, 0x20, 0x00},
    //m
    {0xC0, 0xC0, 0x40, 0x40, 0x80, 0x80, 0x40, 0x40, 0xC0, 0x80, 0x3F, 0x3F, 0x00, 0x00, 0x3F, 0x3F, 0x00, 0x00, 0x3F, 0x3F}
};



//28x32 폰트 배열
flash unsigned char font_28x32 [10][112] = {    //font_28x32
    //0
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xE0, 0xF0, 0x70, 0x38, 0x18, 0x18, 0x18, 0x18,
    0x38, 0x70, 0xF0, 0xE0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0xF0, 0xFF, 0xFF, 0x0F, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x0F,
    0xFF, 0xFF, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1F, 0xFF, 0xFF,
    0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0xFF, 0xFF, 0x1F, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x0F, 0x1F, 0x1C, 0x38,
    0x20, 0x30, 0x30, 0x20, 0x38, 0x1C, 0x1F, 0x0F, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    //1
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0xC0, 0xC0, 0xF8, 0xF8,
    0xF8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x3F, 0x3F, 0x3F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    //2
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xF0, 0x70, 0x38, 0x18, 0x18, 0x18, 0x18,
    0x18, 0x38, 0x70, 0xF0, 0xE0, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x0F, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0,
    0xFF, 0x7F, 0x1F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0,
    0xE0, 0xF0, 0x70, 0x38, 0x1C, 0x0C, 0x06, 0x06, 0x03, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x3F, 0x3F, 0x23, 0x30, 0x30, 0x30,
    0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00},
    //3
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xF0, 0x18, 0x38, 0x08, 0x08, 0x08, 0x08,
    0x38, 0x18, 0xF0, 0xE0, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x07, 0x07, 0x07, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0xC0, 0xC0, 0xF0, 0x7F,
    0x3F, 0x1F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0xE0, 0xE0,
    0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x03, 0x07, 0x0F, 0xFE, 0xFC, 0xF8, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x07, 0x0F, 0x1E, 0x1C, 0x30, 0x38,
    0x20, 0x20, 0x20, 0x20, 0x38, 0x30, 0x1C, 0x1E, 0x0F, 0x07, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00},
    //4
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xE0,
    0xF0, 0xF8, 0xF8, 0xF8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xE0, 0xF0, 0x7C, 0x3E, 0x0F, 0x07, 0x03, 0xFF, 0xFF, 0xFF,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0xF0, 0xFC,
    0x9F, 0xCF, 0xC3, 0xC1, 0xC0, 0xC0, 0xC0, 0xC0, 0x80, 0xFF, 0xFF, 0xFF, 0x80, 0xC0, 0xC0, 0xC0,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x3F, 0x3F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    //5
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xF8, 0xF8, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18,
    0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xF0, 0xFF, 0xFF, 0xE7, 0x70, 0x70, 0x30, 0x30, 0x30, 0x30, 0x70, 0x70, 0xE0, 0xC0,
    0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01,
    0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xFF, 0xFF, 0xFC, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x0F, 0x1F, 0x1C, 0x30, 0x38, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x38, 0x18, 0x1C, 0x1F, 0x0F, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    //6
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xE0, 0xF0, 0x70, 0x38, 0x38, 0x18, 0x18, 0x18,
    0x38, 0x38, 0xF0, 0xF0, 0xE0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0xF0, 0xFE, 0xFF, 0x8F, 0xC1, 0xC0, 0xE0, 0x60, 0x60, 0x60, 0x60, 0x60, 0xE0, 0xC0, 0xC3,
    0x83, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF,
    0x07, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0xFF, 0xFF, 0xFC, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x0F, 0x1F, 0x1C, 0x30, 0x38,
    0x20, 0x20, 0x20, 0x20, 0x30, 0x30, 0x18, 0x1E, 0x0F, 0x07, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00},
    //7
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18,
    0x18, 0x98, 0xC8, 0xF8, 0xF8, 0x78, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xF0, 0xFC, 0x7F, 0x1F, 0x07, 0x01,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xC0, 0xF8, 0xFF, 0x7F, 0x07, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3E, 0x3F, 0x3F,
    0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    //8
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xF0, 0x70, 0x38, 0x18, 0x18, 0x18, 0x18,
    0x18, 0x38, 0x70, 0xF0, 0xE0, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x1F, 0x3F, 0x7F, 0xF0, 0xE0, 0xC0, 0x80, 0x80, 0x80, 0x80, 0x80, 0xC0, 0xE0, 0xF0,
    0x7F, 0x3F, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xFC, 0xFE,
    0x0F, 0x07, 0x03, 0x03, 0x01, 0x01, 0x01, 0x01, 0x03, 0x03, 0x07, 0x0F, 0xFF, 0xFE, 0xFC, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x07, 0x0F, 0x1E, 0x1C, 0x30, 0x38,
    0x20, 0x20, 0x20, 0x20, 0x38, 0x30, 0x18, 0x1C, 0x0F, 0x07, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00},
    //9
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xE0, 0xF0, 0x70, 0x38, 0x38, 0x18, 0x18, 0x18, 0x18,
    0x38, 0x38, 0x70, 0xF0, 0xE0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x7F, 0xFF, 0xFF, 0x81, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC1,
    0xDD, 0xFF, 0xFE, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03,
    0x07, 0x07, 0x0E, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0E, 0x06, 0x07, 0xE3, 0xFB, 0xFF, 0x1F, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x0F, 0x1F, 0x1C, 0x38, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x38, 0x1C, 0x1E, 0x0F, 0x07, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}
};


// 16*32 (:)폰트 배열
flash unsigned char dot_font [4][16] = {     //dot_font
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x07, 0x07, 0x07, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xC0, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x03, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}
};


void com_write(unsigned int com)
{
    TWCR=0xA4;    //Send START
    while (!(TWCR & (1<<TWINT)));

    TWDR=add;    //slave address + R/W
    TWCR=0x84;
    while (!(TWCR & (1<<TWINT)));
    
    TWDR=0x00;    //command 모드
    TWCR=0x84;
    while (!(TWCR & (1<<TWINT)));

    TWDR=com;    //data 출력
    TWCR=0x84;
    while (!(TWCR & (1<<TWINT)));

    TWCR=0x94;    //Send STOP
}

//SSD1306 데이터 전송 함수
void data_write(unsigned int data)
{
    TWCR=0xA4;    //Send START
    while (!(TWCR & (1<<TWINT)));

    TWDR=add;    //slave address + R/W
    TWCR=0x84;
    while (!(TWCR & (1<<TWINT)));
    
    TWDR=0x40;    //data 모드
    TWCR=0x84;
    while (!(TWCR & (1<<TWINT)));

    TWDR=data;    //data 출력
    TWCR=0x84;
    while (!(TWCR & (1<<TWINT)));

    TWCR=0x94;    //Send STOP
}


//128x32 비트맵 전송 함수
void bit_draw(flash unsigned char *ch)
{
    unsigned char x,y;
    unsigned int i=0;

    for(y=0;y<4;y++)
    {
        com_write(0xb0+y);    //(Y축 주소 지정 커맨드 범위(B0~B3))
        com_write(0x00);    // X축 주소
        com_write(0x10);    // X축 주소

        for(x=0;x<128;x++)
        {
            data_write(ch[i++]);        //ATMEGA8의 EEPROM이 아닌 플래시 메모리에 배열을 저장했기 때문에 pgm_read_byte로 읽어야한다.
        }
    }
}


//10x16 폰트 출력 함수
void draw_font_10x16(int x, int y, int ch)
{
    unsigned int i, j, k =0;
    unsigned int high, low;

    high = x / 16;
    low = x % 16;

    for(i=0; i<2; i++)
    {
        com_write(0xb0+i+y);
        com_write(0x00+low);
        com_write(0x10+high);
        for(j=0; j < 10; j++)
        {
            data_write(font_10x16[ch][k++]);
        }
    }
}



//28x32 폰트 출력 함수
void draw_font_28x32 (int x, int ch)
{
    unsigned int i, j, k =0;
    unsigned int high, low;

    high = x / 16;
    low = x % 16;

    for(i=0; i<4; i++)
    {
        com_write(0xb0+i);
        com_write(0x00+low);
        com_write(0x10+high);

        for(j=0; j < 28; j++)
        {
            data_write(font_28x32[ch][k++]);
        }
    }
}

void draw_dot(int x)
{
    unsigned int i, j, k =0;
    unsigned int high, low;

    high = x / 16;
    low = x % 16;

    for(i=0; i<4; i++)
    {
        k =0;
        com_write(0xb0+i);
        com_write(0x00+low);
        com_write(0x10+high);

        for(j=0; j < 16; j++)
        {
            data_write(dot_font[i][k++]);
        }
    }
}

//OLED 화면 클리어 함수
void oled_clear(void)
{
    unsigned int i, j;

    for(i=0; i<4; i++)
    {
        com_write(0xb0+i);
        com_write(0x00);
        com_write(0x10);
        for(j=0; j < 128; j++)
        {
            data_write(0x00);    //0X00으로 전부 채운다.
        }
    }
}

//OLED 화면 초기화 함수
void oled_init(void)
{
    com_write(0xAE); //display off
    com_write(0x20); //Set Memory Addressing Mode
    com_write(0x10); //00,Horizontal Addressing Mode;01,Vertical Addressing Mode;10,Page Addressing Mode (RESET);11,Invalid
    com_write(0xb0); //Set Page Start Address for Page Addressing Mode,0-7
    com_write(0xc8); //Set COM Output Scan Direction
    com_write(0x00); //---set low column address
    com_write(0x10); //---set high column address
    com_write(0x40); //--set start line address

    com_write(0x81); //--set contrast control register*
    com_write(0xFF);

    com_write(0xa1); //--set segment re-map 0 to 127
    com_write(0xa6); //--set normal display
    com_write(0xa8); //--set multiplex ratio(1 to 64)
    com_write(0x1F); //
    com_write(0xa4); //0xa4,Output follows RAM content;0xa5,Output ignores RAM content
    com_write(0xd3); //-set display offset
    com_write(0x00); //-not offset
    com_write(0xd5); //--set display clock divide ratio/oscillator frequency
    com_write(0xf0); //--set divide ratio
    com_write(0xd9); //--set pre-charge period

    com_write(0x22); //
    com_write(0xda); //--set com pins hardware configuration
    com_write(0x02);
    com_write(0xdb); //--set vcomh

    com_write(0x20); //0x20,0.77xVcc
    com_write(0x8d); //--set DC-DC enable
    com_write(0x14); //
    com_write(0xaf); //--turn on oled panel
}

void digit_num(int k)
{
    digit_1 = k % 10;
    digit_10 = (k / 10) % 10;
    digit_100 = (k / 100) % 10;
    digit_1000 = k / 1000;
}

interrupt [TIM0_OVF] void timer0_ovf_isr(void)
{
    TCNT0=140;
    distance++;
}

interrupt [EXT_INT0] void ext_int0_isr(void)
{
     if(edge_mode == 0)
    {
        distance = 0;
        TIMSK=0x01; // 오버플로우 인터럽트 설정 0
        TCCR0=0x02;    //프리스케일 설정
        TCNT0=140;    //시작 레지스터 설정
        MCUCR=0x02;    //하강에지로 설정
        edge_mode = 1;
    }

    else
    {
        TIMSK=0x00; //오버플로우 인터럽트 설정 x
        edge_mode = 0;

        //450 미만(4.5M 미만)일때의 값은 무시
        if(distance < 450)
        {
            sum = sum + distance;
            avg_cnt++;
        }

        //10번 측정한 값을 평균내서 출력
        if(avg_cnt == 10)
        {
            digit_num(sum/avg_cnt);
            avg_cnt=0;
            sum=0;
        }
        MCUCR=0x03;    //상승에지로 설정
    }
}

void main(void)
{
    DDRC = 0xFF; //
    DDRD = 0x01; 

    TWBR = 12;    //(CPU_Clock/SCL_Clock) - 16)/2 = TWBR*(4^TWPS) -> 통신속도 400kHz설정
    TWSR = 0x00;       

    GICR=0x40;    //인터럽트  인에이블
    MCUCR=0x03;   //처음은 상승 엣지로 설정
    SREG=0x80;    //인터럽트 허용

    oled_init();    //OLED 초기화
    delay_ms(50);
    
    bit_draw(gretting_screen);    //초기화면 DISTANACE MEASURER 출력
    delay_ms(1000);
    
    oled_clear();
    //draw_dot(57);

    while(1)
    {
        PORTD=0x01;
        delay_us(10);    //초음파센서 트리거 발생
        PORTD=0x00;
        draw_font_28x32(84,digit_1);       //1의 자리 출력
        draw_font_28x32(56,digit_10);      //10의자리 출력
        draw_font_28x32(28,digit_100);     //100의 자리 출력
        draw_font_28x32(0,digit_1000);     //1000의 자리 출력
        draw_font_10x16(0,4,4);
        delay_ms(50);
    }
}
